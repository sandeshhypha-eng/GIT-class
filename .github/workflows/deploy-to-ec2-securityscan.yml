name: CI/CD â€” Build, Security Scan, and Deploy to EC2

on:
  push:
    branches: [ CalculatorApp ]
  workflow_dispatch:

jobs:

  # ================================
  # BUILD JOB
  # ================================
  build:
    name: Build Application
    runs-on: ubuntu-latest

    steps:

      # Checkout source code
      - name: Checkout source code
        uses: actions/checkout@v4


      # Install Java 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'


      # Cache Maven dependencies for faster builds
      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}


      # Build JAR file
      - name: Build JAR
        run: |
          mvn -B -f CalculatorProject/pom.xml clean package -DskipTests


      # Upload JAR as artifact
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: calculator-jar
          path: CalculatorProject/target/CalculatorProject-1.0.jar



  # ================================
  # SECURITY SCAN JOB
  # ================================
  security-scan:
    name: Security Scan (SpotBugs + OWASP)
    needs: build
    runs-on: ubuntu-latest

    steps:

      # Checkout code
      - name: Checkout source code
        uses: actions/checkout@v4


      # Install Java
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'


      # Cache dependencies
      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}


      # Run Static Code Analysis
      - name: Run SpotBugs Scan
        run: |
          mvn -B -f CalculatorProject/pom.xml com.github.spotbugs:spotbugs-maven-plugin:spotbugs


      # Run Dependency Vulnerability Scan
      - name: Run OWASP Dependency Check
        run: |
          mvn -B -f CalculatorProject/pom.xml org.owasp:dependency-check-maven:check


      # Upload Security Reports
      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            CalculatorProject/target/dependency-check-report.html
            CalculatorProject/target/spotbugsXml.xml



  # ================================
  # DEPLOY JOB
  # ================================
  deploy:
    name: Deploy to EC2
    needs: [build, security-scan]
    runs-on: ubuntu-latest

    steps:

      # Checkout repository
      - name: Checkout source code
        uses: actions/checkout@v4


      # Download built JAR
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: calculator-jar
          path: ./artifact


      # Setup SSH
      - name: Prepare SSH
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$SERVER_IP" >> ~/.ssh/known_hosts


      # Copy files to EC2
      - name: Copy files to EC2
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          scp -i ~/.ssh/id_rsa CalculatorProject/systemd/calculator.service "$SERVER_USER@$SERVER_IP:/tmp/calculator.service"

          scp -i ~/.ssh/id_rsa artifact/CalculatorProject-1.0.jar "$SERVER_USER@$SERVER_IP:/tmp/CalculatorProject-1.0.jar"


      # Deploy and restart service
      - name: Deploy Application on EC2
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          ssh -i ~/.ssh/id_rsa "$SERVER_USER@$SERVER_IP" bash -s << 'EOF'

          set -e

          echo "Creating directories..."
          sudo mkdir -p /opt/calculator
          sudo mkdir -p /var/log/calculator

          echo "Moving JAR..."
          sudo mv /tmp/CalculatorProject-1.0.jar /opt/calculator/

          echo "Moving service file..."
          sudo mv /tmp/calculator.service /etc/systemd/system/

          echo "Setting permissions..."
          sudo chown -R root:root /opt/calculator

          echo "Checking Java installation..."
          if ! command -v java >/dev/null 2>&1
          then
            echo "Installing Java..."
            sudo yum update -y
            sudo yum install -y java-17-amazon-corretto-headless
          fi

          echo "Reloading systemd..."
          sudo systemctl daemon-reload

          echo "Enabling service..."
          sudo systemctl enable calculator.service

          echo "Restarting service..."
          sudo systemctl restart calculator.service

          echo "Deployment successful!"

          EOF


      # Final confirmation
      - name: Notify Success
        run: echo "Application deployed successfully to EC2"