# Workflow name shown in GitHub Actions UI
name: Build and Deploy Calculator to Amazon Linux

# When should this pipeline run?
on:
  workflow_dispatch:     # Allows manual trigger from GitHub UI

jobs:

# =====================================================
# 1Ô∏è‚É£ BUILD JOB
# =====================================================
  build:
    runs-on: ubuntu-latest   # GitHub provides an Ubuntu VM

    steps:
      # Step 1: Download repository code to runner
      - name: Checkout source code
        uses: actions/checkout@v4

      # Step 2: Install Java 21 on the GitHub runner
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin       # Java distribution
          java-version: '21'          # Required Java version
          cache: maven                # Cache Maven dependencies (faster builds)

      # Step 3: Compile and package the application
      - name: Build with Maven
        run: |
          cd CalculatorProject        # Move into project directory
          mvn clean package           # Clean old builds and create JAR

      # Step 4: Save the built JAR so other jobs can use it
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: calculator-jar        # Artifact name
          path: CalculatorProject/target/CalculatorProject-*.jar


# =====================================================
# 2Ô∏è‚É£ SERVER PREPARATION JOB
# =====================================================
  server-preparation:
    runs-on: ubuntu-latest
    needs: build        # This job runs only after build succeeds

    steps:
      # Create SSH configuration to connect to EC2
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa      # Secure the key (required by SSH)

      # Install Java on EC2 if not installed
      - name: Install Java on EC2
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=accept-new \
          ec2-user@${{ secrets.EC2_HOST }} << 'EOF'

          # Check if Java exists
          if ! command -v java &> /dev/null; then
            echo "Java not found. Installing..."
            sudo yum install -y java-21-amazon-corretto
          fi

          java -version   # Print installed version
          mkdir -p ~/calculator-app   # Create app directory

          EOF


# =====================================================
# 3Ô∏è‚É£ DEPLOY JOB (Run as Background Daemon using systemd)
# =====================================================
  deploy:
    runs-on: ubuntu-latest
    needs: server-preparation   # Runs only after server is ready

    steps:
      # Download JAR from build job
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: calculator-jar

      # Setup SSH again (each job runs in fresh VM)
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      # Copy JAR file to EC2
      - name: Copy JAR to EC2
        run: |
          scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=accept-new \
          CalculatorProject-*.jar \
          ec2-user@${{ secrets.EC2_HOST }}:~/calculator-app/app.jar

      # Create systemd service to run app as daemon
      - name: Configure and Start systemd Service
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=accept-new \
          ec2-user@${{ secrets.EC2_HOST }} << 'EOF'

          APP_DIR="/home/ec2-user/calculator-app"
          JAR_PATH="$APP_DIR/app.jar"

          # Create systemd service file
          sudo tee /etc/systemd/system/calculator.service > /dev/null <<EOL
          [Unit]
          Description=Calculator Spring Boot Application
          After=network.target   # Start after network is ready

          [Service]
          Type=simple
          User=ec2-user
          WorkingDirectory=$APP_DIR
          ExecStart=/usr/bin/java -Xmx512m -jar $JAR_PATH --server.port=8080
          SuccessExitStatus=143
          Restart=always         # Auto restart if app crashes
          RestartSec=5           # Wait 5 sec before restart

          [Install]
          WantedBy=multi-user.target   # Start on system boot
          EOL

          # Reload systemd to recognize new service
          sudo systemctl daemon-reload

          # Enable service to start on reboot
          sudo systemctl enable calculator

          # Start (or restart) service
          sudo systemctl restart calculator

          # Show service status
          sudo systemctl status calculator --no-pager

          EOF


# =====================================================
# 4Ô∏è‚É£ VERIFY DEPLOYMENT
# =====================================================
  verify:
    runs-on: ubuntu-latest
    needs: deploy   # Run only if deployment succeeded

    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Verify Service and Port
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=accept-new \
          ec2-user@${{ secrets.EC2_HOST }} << 'EOF'

          echo "Checking if service is active..."
          sudo systemctl is-active calculator || exit 1

          echo "Checking if port 8080 is listening..."
          (netstat -tulnp 2>/dev/null || ss -tulnp 2>/dev/null) | grep 8080 || exit 1

          echo "Deployment verification successful."

          EOF


# =====================================================
# 5Ô∏è‚É£ NOTIFICATION JOB
# =====================================================
  notify:
    runs-on: ubuntu-latest
    needs: verify
    if: success()    # Only run if everything succeeded

    steps:
      - name: Deployment Success Message
        run: |
          echo "======================================="
          echo "üöÄ Deployment Successful!"
          echo "======================================="
          echo "Application URL:"
          echo "http://${{ secrets.EC2_HOST }}:8080"
          echo "======================================="
