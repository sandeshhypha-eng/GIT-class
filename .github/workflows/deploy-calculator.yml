name: Build and Deploy Calculator to Amazon Linux

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'CalculatorProject/**'
      - '.github/workflows/deploy-calculator.yml'
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: |
          cd CalculatorProject
          mvn clean package -DskipTests

      - name: Run tests
        run: |
          cd CalculatorProject
          mvn test

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: calculator-jar
          path: CalculatorProject/target/CalculatorProject-*.jar
          if-no-files-found: error

  deploy-to-amazon-linux:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: calculator-jar

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Create app directory on EC2
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=accept-new \
            ec2-user@${{ secrets.EC2_HOST }} \
            "mkdir -p ~/calculator-app && chmod 755 ~/calculator-app"

      - name: Copy JAR to EC2
        run: |
          scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=accept-new \
            CalculatorProject-*.jar ec2-user@${{ secrets.EC2_HOST }}:~/calculator-app/

      - name: Deploy and start application
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=accept-new \
            ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
          
          set -e
          
          APP_DIR="$HOME/calculator-app"
          APP_PORT=8080
          APP_PID_FILE="$APP_DIR/app.pid"
          JAR_FILE=$(ls $APP_DIR/CalculatorProject-*.jar | tail -1)
          
          echo "Deploying application..."
          echo "JAR file: $JAR_FILE"
          
          # Stop existing application if running
          if [ -f "$APP_PID_FILE" ]; then
            PID=$(cat "$APP_PID_FILE")
            if kill -0 $PID 2>/dev/null; then
              echo "Stopping existing application (PID: $PID)..."
              kill $PID || true
              sleep 2
            fi
          fi
          
          # Start the application in the background
          echo "Starting Calculator application on port $APP_PORT..."
          nohup java -Xmx512m -jar "$JAR_FILE" \
            --server.port=$APP_PORT \
            > $APP_DIR/app.log 2>&1 &
          
          APP_PID=$!
          echo $APP_PID > "$APP_PID_FILE"
          
          echo "Application started with PID: $APP_PID"
          sleep 3
          
          # Check if process is still running
          if ! kill -0 $APP_PID 2>/dev/null; then
            echo "✗ Application failed to start"
            tail -20 $APP_DIR/app.log
            exit 1
          fi
          
          echo "✓ Application started successfully"
          echo "View logs: tail -f $APP_DIR/app.log"
          
          EOF

      - name: Verify deployment
        run: |
          echo "Verifying application health..."
          max_attempts=30
          for i in $(seq 1 $max_attempts); do
            if curl -f http://${{ secrets.EC2_HOST }}:8080 2>/dev/null; then
              echo "✓ Application is responding on http://${{ secrets.EC2_HOST }}:8080"
              exit 0
            fi
            echo "Attempt $i/$max_attempts - waiting for application..."
            sleep 2
          done
          
          echo "✗ Application health check failed after $max_attempts attempts"
          echo "Checking application logs..."
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=accept-new \
            ec2-user@${{ secrets.EC2_HOST }} \
            "tail -30 ~/calculator-app/app.log" || true
          
          exit 1

      - name: Deployment success notification
        if: success()
        run: |
          echo "================================================"
          echo "✓ Deployment completed successfully!"
          echo "================================================"
          echo ""
          echo "Application Details:"
          echo "  URL: http://${{ secrets.EC2_HOST }}:8080"
          echo "  Host: ${{ secrets.EC2_HOST }}"
          echo ""
          echo "To monitor logs on EC2, run:"
          echo "  ssh -i /path/to/key.pem ec2-user@${{ secrets.EC2_HOST }} 'tail -f ~/calculator-app/app.log'"
          echo ""
